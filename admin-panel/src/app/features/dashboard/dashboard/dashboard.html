<div class="dashboard-container">
  <!-- Compact DateTime Header -->
  <div class="datetime-header">
    <div class="datetime-info">
      <div class="current-date">{{ currentDate | date:'EEEE, d MMMM y' }}</div>
      <div class="current-time">{{ currentTime | date:'HH:mm:ss' }}</div>
    </div>
    <button mat-icon-button color="primary" (click)="refreshData()" [disabled]="loading" class="refresh-btn">
      <mat-icon>refresh</mat-icon>
    </button>
  </div>

  <!-- Welcome Section -->
  <div class="welcome-section">
    <div class="welcome-header">
      <div class="welcome-text">
        <h1>{{ 'dashboard.welcome' | translate }}, {{ currentUser?.name }}!</h1>
        <p>{{ 'nav.dashboard' | translate }}</p>
      </div>
    </div>
  </div>

  <!-- Quick Actions - Moved to Top for Mobile -->
  <div class="quick-actions-section">
    <mat-card class="quick-actions-card">
      <mat-card-content>
        <div class="action-buttons">
          <button mat-raised-button color="primary" (click)="navigateTo('/appointments')" class="action-btn">
            <mat-icon>event</mat-icon>
            <span>{{ 'nav.appointments' | translate }}</span>
          </button>
          <button mat-raised-button color="accent" (click)="navigateTo('/services')" class="action-btn">
            <mat-icon>build</mat-icon>
            <span>{{ 'nav.services' | translate }}</span>
          </button>
          <button mat-raised-button (click)="navigateTo('/organizations')" class="action-btn">
            <mat-icon>business</mat-icon>
            <span>{{ 'nav.organizations' | translate }}</span>
          </button>
          <button mat-raised-button (click)="navigateTo('/settings')" class="action-btn">
            <mat-icon>settings</mat-icon>
            <span>{{ 'nav.settings' | translate }}</span>
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <div class="stats-section" *ngIf="!loading; else loadingTemplate">
    <!-- Desktop/Tablet Grid -->
    <mat-grid-list cols="4" rowHeight="120px" gutterSize="16px" class="desktop-stats">
      <mat-grid-tile>
        <mat-card class="stat-card stat-primary" (click)="onStatClick('totalAppointments')">
          <mat-card-content>
            <div class="stat-content">
              <mat-icon class="stat-icon">event</mat-icon>
              <div class="stat-info">
                <div class="stat-number">{{ stats.totalAppointments }}</div>
                <div class="stat-label">{{ 'dashboard.stats.totalAppointments' | translate }}</div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </mat-grid-tile>

      <mat-grid-tile>
        <mat-card class="stat-card stat-success" (click)="onStatClick('todayAppointments')">
          <mat-card-content>
            <div class="stat-content">
              <mat-icon class="stat-icon">today</mat-icon>
              <div class="stat-info">
                <div class="stat-number">{{ stats.todayAppointments }}</div>
                <div class="stat-label">{{ 'dashboard.stats.todayAppointments' | translate }}</div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </mat-grid-tile>

      <mat-grid-tile>
        <mat-card class="stat-card stat-warning" (click)="onStatClick('pendingAppointments')">
          <mat-card-content>
            <div class="stat-content">
              <mat-icon class="stat-icon">schedule</mat-icon>
              <div class="stat-info">
                <div class="stat-number">{{ stats.pendingAppointments }}</div>
                <div class="stat-label">{{ 'dashboard.stats.pendingAppointments' | translate }}</div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </mat-grid-tile>

      <mat-grid-tile>
        <mat-card class="stat-card stat-info" (click)="onStatClick('totalServices')">
          <mat-card-content>
            <div class="stat-content">
              <mat-icon class="stat-icon">build</mat-icon>
              <div class="stat-info">
                <div class="stat-number">{{ stats.totalServices }}</div>
                <div class="stat-label">{{ 'dashboard.stats.totalServices' | translate }}</div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </mat-grid-tile>
    </mat-grid-list>

    <!-- Mobile Cards with Labels Above -->
    <div class="mobile-stats">
      <div class="mobile-stats-row">
        <div class="stat-label-mobile">{{ 'dashboard.stats.totalAppointments' | translate }}</div>
        <mat-card class="stat-card-mobile stat-primary" (click)="onStatClick('totalAppointments')">
          <mat-card-content class="stat-content-mobile">
            <mat-icon class="stat-icon-mobile">event</mat-icon>
            <div class="stat-number-mobile">{{ stats.totalAppointments }}</div>
          </mat-card-content>
        </mat-card>
      </div>

      <div class="mobile-stats-row">
        <div class="stat-label-mobile">{{ 'dashboard.stats.todayAppointments' | translate }}</div>
        <mat-card class="stat-card-mobile stat-success" (click)="onStatClick('todayAppointments')">
          <mat-card-content class="stat-content-mobile">
            <mat-icon class="stat-icon-mobile">today</mat-icon>
            <div class="stat-number-mobile">{{ stats.todayAppointments }}</div>
          </mat-card-content>
        </mat-card>
      </div>

      <div class="mobile-stats-row">
        <div class="stat-label-mobile">{{ 'dashboard.stats.pendingAppointments' | translate }}</div>
        <mat-card class="stat-card-mobile stat-warning" (click)="onStatClick('pendingAppointments')">
          <mat-card-content class="stat-content-mobile">
            <mat-icon class="stat-icon-mobile">schedule</mat-icon>
            <div class="stat-number-mobile">{{ stats.pendingAppointments }}</div>
          </mat-card-content>
        </mat-card>
      </div>

      <div class="mobile-stats-row">
        <div class="stat-label-mobile">{{ 'dashboard.stats.totalServices' | translate }}</div>
        <mat-card class="stat-card-mobile stat-info" (click)="onStatClick('totalServices')">
          <mat-card-content class="stat-content-mobile">
            <mat-icon class="stat-icon-mobile">build</mat-icon>
            <div class="stat-number-mobile">{{ stats.totalServices }}</div>
          </mat-card-content>
        </mat-card>
      </div>
    </div>
  </div>

  <ng-template #loadingTemplate>
    <div class="loading-section">
      <mat-spinner diameter="50"></mat-spinner>
      <p>{{ 'common.loading' | translate }}</p>
    </div>
  </ng-template>

  <!-- Calendar - Moved to Top for Better Visibility -->
  <div class="calendar-section">
    <mat-card class="calendar-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>calendar_month</mat-icon>
          {{ 'calendar.appointments' | translate }}
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <mat-calendar 
          [selected]="selectedDate"
          (selectedChange)="onDateSelected($event)"
          class="appointment-calendar">
        </mat-calendar>
      </mat-card-content>
    </mat-card>
  </div>

  <div class="main-content">
    <div class="left-column">

    <div class="right-column">
      <!-- Записи на выбранную дату -->
      <mat-card class="selected-date-card" *ngIf="selectedDate">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>event</mat-icon>
            {{ 'calendar.appointments' | translate }} - {{ selectedDate | date:'dd.MM.yyyy' }}
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="appointments-list" *ngIf="getAppointmentsForDate(selectedDate).length > 0; else noAppointments">
            <div 
              *ngFor="let appointment of getAppointmentsForDate(selectedDate)" 
              class="appointment-item"
              [ngClass]="getAppointmentStatusClass(appointment.status)">
              <div class="appointment-time">{{ formatAppointmentTime(appointment) }}</div>
              <div class="appointment-service">{{ getServiceName(appointment.service) || ('services.title' | translate) }}</div>
              <div class="appointment-chat">ID: {{ appointment.chatId }}</div>
            </div>
          </div>
          <ng-template #noAppointments>
            <p class="no-appointments">{{ 'calendar.noAppointments' | translate }}</p>
          </ng-template>
        </mat-card-content>
      </mat-card>

      <!-- Recent Appointments with Improved Design -->
      <mat-card class="recent-appointments-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>history</mat-icon>
            {{ 'calendar.recentAppointments' | translate }}
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="appointments-list" *ngIf="recentAppointments.length > 0; else noRecentAppointments">
            <div *ngFor="let appointment of recentAppointments" class="appointment-item">
              <div class="appointment-header">
                <div class="appointment-service">{{ getServiceName(appointment.service) || ('services.title' | translate) }}</div>
                <div class="appointment-status">
                  <div class="status-dot" [ngClass]="getAppointmentStatusClass(appointment.status)"></div>
                  <span class="status-text">{{ getStatusText(appointment.status) }}</span>
                </div>
              </div>
              <div class="appointment-details">
                <div class="appointment-date-time">
                  <span class="appointment-date">{{ formatAppointmentDate(appointment) }}</span>
                  <span class="appointment-time">{{ formatAppointmentTime(appointment) }}</span>
                </div>
                <div class="appointment-id">ID: {{ appointment.chatId }}</div>
              </div>
            </div>
          </div>
          <ng-template #noRecentAppointments>
            <p class="no-appointments">{{ 'appointments.noData.message' | translate }}</p>
          </ng-template>
        </mat-card-content>
      </mat-card>

    </div>
  </div>

  <!-- API тестирование (скрыто по умолчанию) -->
  <div class="api-test-section" style="display: none;">
    <h2>Тестирование API</h2>
    <app-api-test></app-api-test>
  </div>
</div>
