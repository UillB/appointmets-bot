<div class="ai-config-container">
  <div class="header">
    <h1>ü§ñ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞</h1>
    <p>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞–º –≤ Telegram –±–æ—Ç–µ</p>
  </div>

  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ AI...</p>
  </div>

  <div *ngIf="!isLoading" class="config-content">
    <mat-tab-group>
      <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
      <mat-tab label="‚öôÔ∏è –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏">
        <div class="tab-content">
          <mat-card class="config-card">
            <mat-card-header>
              <mat-card-title>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è AI</mat-card-title>
              <mat-card-subtitle>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</mat-card-subtitle>
            </mat-card-header>
            
            <mat-card-content>
              <form [formGroup]="aiConfigForm" class="config-form">
                <div class="form-row">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>–ü—Ä–æ–≤–∞–π–¥–µ—Ä AI</mat-label>
                    <mat-select formControlName="provider" (selectionChange)="onProviderChange()">
                      <mat-option *ngFor="let provider of providers" [value]="provider.value">
                        {{ provider.icon }} {{ provider.label }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>API –ö–ª—é—á</mat-label>
                    <input matInput formControlName="apiKey" type="password" placeholder="sk-...">
                    <mat-hint>–í–∞—à API –∫–ª—é—á –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞</mat-hint>
                  </mat-form-field>
                  <button mat-stroked-button 
                          type="button" 
                          (click)="validateApiKey()" 
                          [disabled]="isValidatingApiKey || !aiConfigForm.get('apiKey')?.value">
                    <mat-spinner *ngIf="isValidatingApiKey" diameter="20"></mat-spinner>
                    <mat-icon *ngIf="!isValidatingApiKey">check_circle</mat-icon>
                    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–ª—é—á
                  </button>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>–ú–æ–¥–µ–ª—å</mat-label>
                    <mat-select formControlName="model">
                      <mat-option *ngFor="let model of availableModels" [value]="model.id">
                        {{ model.name }}
                        <span *ngIf="model.description" class="model-description"> - {{ model.description }}</span>
                      </mat-option>
                    </mat-select>
                    <mat-hint>–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</mat-hint>
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="half-width">
                    <mat-label>–ú–∞–∫—Å–∏–º—É–º —Ç–æ–∫–µ–Ω–æ–≤</mat-label>
                    <input matInput formControlName="maxTokens" type="number" min="100" max="4000">
                    <mat-hint>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞</mat-hint>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="half-width">
                    <mat-label>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</mat-label>
                    <input matInput formControlName="temperature" type="number" min="0" max="2" step="0.1">
                    <mat-hint>–ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–æ–≤ (0-2)</mat-hint>
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç</mat-label>
                    <textarea matInput 
                              formControlName="systemPrompt" 
                              rows="4"
                              placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞..."></textarea>
                    <mat-hint>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è AI (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</mat-hint>
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-slide-toggle formControlName="enabled" color="primary">
                    –í–∫–ª—é—á–∏—Ç—å AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
                  </mat-slide-toggle>
                </div>
              </form>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

      <!-- –ö–∞—Å—Ç–æ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã -->
      <mat-tab label="üí¨ –ö–∞—Å—Ç–æ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã">
        <div class="tab-content">
          <mat-card class="config-card">
            <mat-card-header>
              <mat-card-title>–ü—Ä–æ–º–ø—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤</mat-card-title>
              <mat-card-subtitle>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π</mat-card-subtitle>
            </mat-card-header>
            
            <mat-card-content>
              <form [formGroup]="customPromptsForm" class="prompts-form">
                <mat-expansion-panel *ngFor="let scenario of scenarios" class="prompt-panel">
                  <mat-expansion-panel-header>
                    <mat-panel-title>
                      {{ getScenarioIcon(scenario.key) }} {{ scenario.label }}
                    </mat-panel-title>
                  </mat-expansion-panel-header>
                  
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>–ü—Ä–æ–º–ø—Ç –¥–ª—è {{ scenario.label.toLowerCase() }}</mat-label>
                    <textarea matInput 
                              [formControlName]="scenario.key"
                              [placeholder]="scenario.placeholder"
                              rows="5"></textarea>
                    <mat-hint>–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞</mat-hint>
                  </mat-form-field>
                </mat-expansion-panel>
              </form>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

      <!-- –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã -->
      <mat-tab label="‚öôÔ∏è –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã">
        <div class="tab-content">
          <mat-card class="config-card">
            <mat-card-header>
              <mat-card-title>–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ AI</mat-card-title>
              <mat-card-subtitle>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –±–∞–∑–æ–≤—ã–µ –ø—Ä–æ–º–ø—Ç—ã –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞</mat-card-subtitle>
            </mat-card-header>
            
            <mat-card-content>
              <form [formGroup]="advancedPromptsForm" class="advanced-prompts-form">
                
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>–ë–∞–∑–æ–≤—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç</mat-label>
                  <textarea matInput 
                            formControlName="baseSystemPrompt"
                            placeholder="–¢—ã - AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø–æ–º–æ–≥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞–º —Å –∑–∞–ø–∏—Å—å—é –Ω–∞ —É—Å–ª—É–≥–∏ –∏ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã."
                            rows="6"></textarea>
                  <mat-hint>–û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–º–ø—Ç, –∫–æ—Ç–æ—Ä—ã–π –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–æ–ª—å –∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞</mat-hint>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ä–∞–±–æ—Ç–µ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º</mat-label>
                  <textarea matInput 
                            formControlName="contextInstructions"
                            placeholder="–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–∞—Ö. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ –∑–∞–ø–∏—Å–∏, –ø–æ–∫–∞–∂–∏ –±–ª–∏–∂–∞–π—à–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–æ—Ç—ã."
                            rows="5"></textarea>
                  <mat-hint>–ö–∞–∫ AI –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏, —É—Å–ª—É–≥–∞—Ö –∏ —Å–ª–æ—Ç–∞—Ö</mat-hint>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –ø–æ–≤–µ–¥–µ–Ω–∏—é</mat-label>
                  <textarea matInput 
                            formControlName="behaviorInstructions"
                            placeholder="–ë—É–¥—å –≤–µ–∂–ª–∏–≤—ã–º, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º –∏ –ø–æ–ª–µ–∑–Ω—ã–º. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ. –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å –æ—Ç–≤–µ—Ç–∞, –ø—Ä–µ–¥–ª–æ–∂–∏ —Å–≤—è–∑–∞—Ç—å—Å—è –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É."
                            rows="5"></textarea>
                  <mat-hint>–ö–∞–∫ AI –¥–æ–ª–∂–µ–Ω –≤–µ—Å—Ç–∏ —Å–µ–±—è –ø—Ä–∏ –æ–±—â–µ–Ω–∏–∏ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏</mat-hint>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>–ü—Ä–æ–º–ø—Ç –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤</mat-label>
                  <textarea matInput 
                            formControlName="fallbackPrompt"
                            placeholder="–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å! –Ø –ø–æ–º–æ–≥—É –≤–∞–º —Å –∑–∞–ø–∏—Å—å—é –Ω–∞ —É—Å–ª—É–≥–∏ –∏–ª–∏ –æ—Ç–≤–µ—á—É –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –Ω–∞—à–µ–º —Å–∞–ª–æ–Ω–µ. –ú–æ–∂–µ—Ç–µ —Ç–∞–∫–∂–µ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏ –Ω–∞–ø—Ä—è–º—É—é."
                            rows="4"></textarea>
                  <mat-hint>–û—Ç–≤–µ—Ç, –∫–æ—Ç–æ—Ä—ã–π AI –¥–∞—Å—Ç, –µ—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—Ç, –∫–∞–∫ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å</mat-hint>
                </mat-form-field>

              </form>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

      <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
      <mat-tab label="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞">
        <div class="tab-content">
          <mat-card class="config-card">
            <mat-card-header>
              <mat-card-title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è AI</mat-card-title>
              <mat-card-subtitle>–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</mat-card-subtitle>
            </mat-card-header>
            
            <mat-card-content>
              <div *ngIf="isLoadingStats" class="loading-stats">
                <mat-spinner diameter="40"></mat-spinner>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</p>
              </div>
              
              <div *ngIf="!isLoadingStats && usageStats" class="stats-grid">
                <div class="stat-item">
                  <div class="stat-value">{{ usageStats.totalRequests || 0 }}</div>
                  <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤</div>
                </div>
                
                <div class="stat-item">
                  <div class="stat-value">{{ formatTokens(usageStats.totalTokens) }}</div>
                  <div class="stat-label">–¢–æ–∫–µ–Ω–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ</div>
                </div>
                
                <div class="stat-item">
                  <div class="stat-value">{{ (usageStats.averageTokensPerRequest || 0) | number:'1.0-0' }}</div>
                  <div class="stat-label">–°—Ä–µ–¥–Ω–µ–µ —Ç–æ–∫–µ–Ω–æ–≤/–∑–∞–ø—Ä–æ—Å</div>
                </div>
              </div>

              <div *ngIf="!isLoadingStats && usageStats?.requestsByScenario && getScenarioKeys().length > 0" class="scenario-stats">
                <h3>–ó–∞–ø—Ä–æ—Å—ã –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—è–º:</h3>
                <div class="scenario-chips">
                  <mat-chip-set>
                    <mat-chip *ngFor="let scenario of getScenarioKeys()">
                      {{ getScenarioIcon(scenario) }} {{ scenario }}: {{ usageStats?.requestsByScenario?.[scenario] }}
                    </mat-chip>
                  </mat-chip-set>
                </div>
              </div>

              <div *ngIf="!isLoadingStats && !usageStats" class="no-stats">
                <p>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ù–∞—á–Ω–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.</p>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>
    </mat-tab-group>

    <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
    <div class="action-buttons">
      <button mat-raised-button 
              color="accent" 
              (click)="testAI()" 
              [disabled]="isTestingAI || aiConfigForm.invalid">
        <mat-spinner *ngIf="isTestingAI" diameter="20"></mat-spinner>
        <mat-icon *ngIf="!isTestingAI">play_arrow</mat-icon>
        –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å AI
      </button>

      <button mat-raised-button 
              color="primary" 
              (click)="saveConfig()" 
              [disabled]="isSaving || aiConfigForm.invalid">
        <mat-spinner *ngIf="isSaving" diameter="20"></mat-spinner>
        <mat-icon *ngIf="!isSaving">save</mat-icon>
        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
      </button>
    </div>
  </div>
</div>
