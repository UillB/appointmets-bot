generator client {
provider = "prisma-client-js"
}


datasource db {
  provider = "sqlite"
  url = env("DATABASE_URL")
}


model Organization {
  id          Int      @id @default(autoincrement())
  name        String
  description String?  // Описание организации для AI
  address     String?  // Адрес организации
  workingHours String? // Часы работы (например: "Пн-Пт: 9:00-18:00, Сб: 10:00-16:00")
  phone       String?  // Телефон для связи
  email       String?  // Email для связи
  avatar      String?  // URL to avatar image
  botToken    String?  // Telegram bot token
  botUsername String?  // Telegram bot username
  // Subscription fields
  subscriptionPlan     SubscriptionPlan @default(FREE)
  subscriptionStatus   SubscriptionStatus? @default(ACTIVE)
  licenseKey           String?  // Manual license key input (fallback)
  lemonSqueezySubscriptionId String? @unique // Lemon Squeezy subscription ID
  lemonSqueezyCustomerId      String? // Lemon Squeezy customer ID
  lemonSqueezyOrderId        String? // Lemon Squeezy order ID
  subscriptionExpiresAt      DateTime? // Subscription expiration date
  subscriptionStartedAt      DateTime? // When subscription was activated
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  userOrganizations UserOrganization[]
  services    Service[]
  aiConfig    OrganizationAIConfig?
  aiUsageLogs AIUsageLog[]
  notifications Notification[]
  eventLogs   EventLog[]

  @@index([name])
  @@index([botToken])
  @@index([botUsername])
  @@index([createdAt])
  @@index([subscriptionPlan])
  @@index([subscriptionStatus])
  @@index([lemonSqueezySubscriptionId])
}

model User {
  id                Int               @id @default(autoincrement())
  email             String             @unique
  password          String
  name              String
  role              UserRole          @default(MANAGER)
  telegramId        String?           @unique // Telegram user ID for Web App auth
  userOrganizations UserOrganization[]
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  notifications     Notification[]
  eventLogs         EventLog[]

  @@index([email])
  @@index([telegramId])
  @@index([createdAt])
}

enum UserRole {
  SUPER_ADMIN
  OWNER
  MANAGER
}

enum OrganizationRole {
  OWNER
  ADMIN
  MEMBER
}

enum SubscriptionPlan {
  FREE
  PRO
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PAST_DUE
  TRIALING
}

model Service {
  id             Int      @id @default(autoincrement())
  name           String   // fallback name
  nameRu         String?  // русское название
  nameEn         String?  // английское название  
  nameHe         String?  // название на иврите
  description    String?
  descriptionRu  String?
  descriptionEn  String?
  descriptionHe  String?
  durationMin    Int      // e.g., 30
  price          Float?   // стоимость услуги
  currency       String?  @default("RUB") // валюта (RUB, USD, EUR)
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id])
  slots          Slot[]
  appointments   Appointment[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organizationId, createdAt])
  @@index([organizationId, name])
  @@index([price])
}


model Slot {
  id         Int      @id @default(autoincrement())
  serviceId  Int
  service    Service  @relation(fields: [serviceId], references: [id])
  startAt    DateTime
  endAt      DateTime
  capacity   Int      @default(1)
  bookings   Appointment[]

  @@unique([serviceId, startAt]) // ← защищает от повторной генерации
  @@index([serviceId, startAt, endAt])
  @@index([startAt])
  @@index([endAt])
}



model Appointment {
  id         Int      @id @default(autoincrement())
  chatId     String
  serviceId  Int
  service    Service  @relation(fields: [serviceId], references: [id])
  slotId     Int
  slot       Slot     @relation(fields: [slotId], references: [id])
  createdAt  DateTime @default(now())
  status     String   @default("confirmed")

  @@unique([slotId]) // <— добавили
  @@index([chatId])
  @@index([serviceId, createdAt])
  @@index([status, createdAt])
  @@index([createdAt])
}

// AI Configuration for Organizations
model OrganizationAIConfig {
  id                    Int      @id @default(autoincrement())
  organizationId        Int      @unique
  organization          Organization @relation(fields: [organizationId], references: [id])
  provider              String   // 'openai', 'claude', 'custom'
  apiKey                String
  model                 String   // e.g., 'gpt-4o-mini'
  maxTokens             Int?
  temperature           Float?
  systemPrompt          String?  // Legacy field - use baseSystemPrompt instead
  baseSystemPrompt      String?  // Base system prompt for AI
  contextInstructions   String?  // Instructions for context handling
  behaviorInstructions  String?  // Instructions for AI behavior
  fallbackPrompt        String?  // Fallback prompt for unknown questions
  customPrompts         String?  // JSON string with custom prompts for different scenarios
  enabled               Boolean  @default(false)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// AI Usage Logging
model AIUsageLog {
  id             Int      @id @default(autoincrement())
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id])
  tokensUsed     Int
  scenario       String?  // 'greeting', 'booking_help', 'service_info', etc.
  model          String?
  createdAt      DateTime @default(now())

  @@index([organizationId, createdAt])
  @@index([scenario, createdAt])
  @@index([model, createdAt])
  @@index([createdAt])
}

// WebSocket Real-time System Models
model Notification {
  id            String   @id @default(cuid())
  userId        Int
  organizationId Int
  type          String   // EventType enum
  title         String
  message       String
  data          Json?    // Additional event data
  isRead        Boolean  @default(false)
  isArchived    Boolean  @default(false)
  createdAt     DateTime @default(now())
  readAt        DateTime?
  archivedAt    DateTime?
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization  Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@index([userId, isRead])
  @@index([organizationId, createdAt])
  @@index([type, createdAt])
}

model EventLog {
  id            String   @id @default(cuid())
  organizationId Int
  type          String   // EventType enum
  source        String   // 'telegram' | 'admin_panel' | 'api' | 'system'
  userId        Int?
  data          Json
  metadata      Json?
  timestamp     DateTime @default(now())
  
  organization  Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user          User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([organizationId, timestamp])
  @@index([type, timestamp])
  @@index([source, timestamp])
}

// Many-to-many relationship between User and Organization
model UserOrganization {
  id             Int              @id @default(autoincrement())
  userId         Int
  organizationId Int
  role           OrganizationRole @default(OWNER)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization  Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
  @@index([role])
}
